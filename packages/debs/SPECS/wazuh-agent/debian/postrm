#!/bin/sh
# postrm script for wazuh-agent
# Wazuh, Inc 2024

set -ex
export INSTALLATION_WAZUH_DIR="/opt/wazuh-agent"
WAZUH_TMP_DIR="${INSTALLATION_WAZUH_DIR}/tmp"

case "$1" in
    remove|failed-upgrade|abort-install|abort-upgrade|disappear)

        if [ -d ${WAZUH_TMP_DIR} ]; then
            rm -rf ${WAZUH_TMP_DIR}
        fi

        if [ "$1" = "remove" ]; then
            rm -rf ${INSTALLATION_WAZUH_DIR}
            # Rename the files
            find /etc/opt/wazuh-agent -type f -exec mv {} ${INSTALLATION_WAZUH_DIR}/tmp/{}.save \;
        fi

        if getent passwd wazuh >/dev/null 2>&1; then
            deluser wazuh > /dev/null 2>&1
        fi
        ;;

    purge)

        if getent passwd wazuh >/dev/null 2>&1; then
            deluser wazuh > /dev/null 2>&1
        fi
        if getent group wazuh >/dev/null 2>&1; then
            delgroup wazuh > /dev/null 2>&1
        fi
        rm -rf ${INSTALLATION_WAZUH_DIR}
        rm -rf /etc/opt/wazuh-agent
    ;;

    upgrade)
        # If the upgrade downgrades to earlier versions, restore ownership
        echo "Upgrade step"

    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;

esac

exit 0
