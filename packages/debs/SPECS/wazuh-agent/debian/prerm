#!/bin/sh
# prerm script for wazuh-manager
# Wazuh, Inc 2024

set -ex

export INSTALLATION_WAZUH_DIR="/opt/wazuh-agent"

case "$1" in
    upgrade|deconfigure)

      # Stop the services before uninstalling the package
      if command -v systemctl > /dev/null 2>&1 && systemctl > /dev/null 2>&1 && systemctl is-active --quiet wazuh-agent > /dev/null 2>&1; then
          systemctl stop wazuh-agent > /dev/null 2>&1
      elif command -v service > /dev/null 2>&1 && service wazuh-agent status 2>/dev/null | grep "running" > /dev/null 2>&1; then
          service wazuh-agent stop > /dev/null 2>&1
      fi
      ${INSTALLATION_WAZUH_DIR}/bin/wazuh-agent stop > /dev/null 2>&1

      # Process: wazuh-agent
      if pgrep -f "wazuh-agent" > /dev/null 2>&1; then
        kill -15 $(pgrep -f "wazuh-agent") > /dev/null 2>&1
      fi

      if pgrep -f "wazuh-agent" > /dev/null 2>&1; then
        kill -9 $(pgrep -f "wazuh-agent") > /dev/null 2>&1
      fi
    ;;

    remove)

      # Stop the services before uninstalling the package
      # Check for systemd
      if command -v systemctl > /dev/null 2>&1 && systemctl > /dev/null 2>&1 && systemctl is-active --quiet wazuh-agent > /dev/null 2>&1; then
          systemctl stop wazuh-agent > /dev/null 2>&1
      # Check for SysV
      elif command -v service > /dev/null 2>&1 && service wazuh-agent status 2>/dev/null | grep "running" > /dev/null 2>&1; then
          service wazuh-agent stop > /dev/null 2>&1
      fi

      # Here we should have the command to stop wazuh agent service
      pkill wazuh-agent

    ;;

    failed-upgrade)
      if [ -f ${INSTALLATION_WAZUH_DIR}/bin/wazuh-agent ]; then
        pkill wazuh-agent
      fi
    ;;

    *)
      echo "prerm called with unknown argument \`$1'" >&2
      exit 1
    ;;

esac

exit 0
